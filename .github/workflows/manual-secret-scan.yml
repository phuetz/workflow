name: Manual Secret Scan

on:
  workflow_dispatch:
    inputs:
      scan_path:
        description: 'Path to scan (default: entire repo)'
        required: false
        default: '.'
        type: string
      severity_threshold:
        description: 'Minimum severity to report'
        required: false
        default: 'low'
        type: choice
        options:
          - critical
          - high
          - medium
          - low
      fail_on_detection:
        description: 'Fail workflow if secrets found'
        required: false
        default: true
        type: boolean
      create_issue:
        description: 'Create GitHub issue if secrets found'
        required: false
        default: false
        type: boolean

jobs:
  manual-scan:
    name: Manual Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Display scan configuration
        run: |
          echo "üîç Manual Secret Scan Configuration"
          echo "===================================="
          echo "Scan Path: ${{ inputs.scan_path }}"
          echo "Severity Threshold: ${{ inputs.severity_threshold }}"
          echo "Fail on Detection: ${{ inputs.fail_on_detection }}"
          echo "Create Issue: ${{ inputs.create_issue }}"
          echo "===================================="

      - name: Run secret scanner
        id: scan
        run: |
          echo "üîç Running secret scanner on: ${{ inputs.scan_path }}"
          tsx scripts/ci-secret-scan.ts
        continue-on-error: ${{ !inputs.fail_on_detection }}

      - name: Generate SARIF report
        if: always()
        run: tsx scripts/generate-sarif-report.ts

      - name: Filter results by severity
        if: always()
        run: |
          echo "üîß Filtering results by severity: ${{ inputs.severity_threshold }}"

          # Create filtered report based on severity threshold
          node -e "
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('secret-scan-report.json', 'utf8'));

            const severityOrder = { critical: 4, high: 3, medium: 2, low: 1 };
            const threshold = severityOrder['${{ inputs.severity_threshold }}'] || 1;

            const filteredMatches = report.matches.filter(m =>
              severityOrder[m.severity] >= threshold
            );

            const filteredReport = {
              ...report,
              matchesFound: filteredMatches.length,
              matches: filteredMatches,
              criticalIssues: filteredMatches.filter(m => m.severity === 'critical').length,
              highIssues: filteredMatches.filter(m => m.severity === 'high').length,
              mediumIssues: filteredMatches.filter(m => m.severity === 'medium').length,
              lowIssues: filteredMatches.filter(m => m.severity === 'low').length
            };

            fs.writeFileSync('secret-scan-report-filtered.json', JSON.stringify(filteredReport, null, 2));

            console.log('Filtered results:', filteredMatches.length, 'matches');
          "

      - name: Display filtered results
        if: always()
        run: |
          node -e "
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('secret-scan-report-filtered.json', 'utf8'));

            console.log('\\n' + '='.repeat(60));
            console.log('üìä SCAN RESULTS (Threshold: ${{ inputs.severity_threshold }})');
            console.log('='.repeat(60));
            console.log('Files scanned:', report.scannedFiles);
            console.log('Matches found:', report.matchesFound);
            console.log('  üî¥ Critical:', report.criticalIssues);
            console.log('  üü† High:', report.highIssues);
            console.log('  üü° Medium:', report.mediumIssues);
            console.log('  ‚ö™ Low:', report.lowIssues);
            console.log('='.repeat(60) + '\\n');

            if (report.matchesFound > 0) {
              console.log('Top 10 findings:');
              report.matches.slice(0, 10).forEach((m, i) => {
                const icon = m.severity === 'critical' ? 'üî¥' :
                            m.severity === 'high' ? 'üü†' :
                            m.severity === 'medium' ? 'üü°' : '‚ö™';
                console.log(\`\${i + 1}. \${icon} \${m.file}:\${m.line} - \${m.patternName}\`);
              });

              if (report.matchesFound > 10) {
                console.log(\`\\n... and \${report.matchesFound - 10} more\`);
              }
            }
          "

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: manual-scan-${{ github.run_number }}
          path: |
            secret-scan-report.json
            secret-scan-report-filtered.json
            secret-scan-results.sarif
          retention-days: 90

      - name: Create issue if requested
        if: inputs.create_issue && steps.scan.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('secret-scan-report-filtered.json', 'utf8'));

            let body = '## üîç Manual Secret Scan Results\n\n';
            body += `**Triggered by:** @${context.actor}\n`;
            body += `**Scan Path:** \`${{ inputs.scan_path }}\`\n`;
            body += `**Severity Threshold:** ${{ inputs.severity_threshold }}\n`;
            body += `**Date:** ${new Date().toISOString()}\n\n`;

            body += '### Summary:\n\n';
            body += `- **Files Scanned:** ${report.scannedFiles}\n`;
            body += `- **Secrets Found:** ${report.matchesFound}\n`;
            if (report.criticalIssues > 0) body += `- üî¥ **Critical:** ${report.criticalIssues}\n`;
            if (report.highIssues > 0) body += `- üü† **High:** ${report.highIssues}\n`;
            if (report.mediumIssues > 0) body += `- üü° **Medium:** ${report.mediumIssues}\n`;
            if (report.lowIssues > 0) body += `- ‚ö™ **Low:** ${report.lowIssues}\n`;

            body += '\n### Details:\n\n';
            const byFile = {};
            for (const match of report.matches.slice(0, 20)) {
              if (!byFile[match.file]) byFile[match.file] = [];
              byFile[match.file].push(match);
            }

            for (const [file, matches] of Object.entries(byFile)) {
              body += `**üìÑ ${file}**\n`;
              for (const match of matches) {
                const icon = match.severity === 'critical' ? 'üî¥' :
                            match.severity === 'high' ? 'üü†' :
                            match.severity === 'medium' ? 'üü°' : '‚ö™';
                body += `- ${icon} Line ${match.line}: ${match.patternName}\n`;
              }
              body += '\n';
            }

            if (report.matchesFound > 20) {
              body += `*... and ${report.matchesFound - 20} more findings. See artifact for full details.*\n\n`;
            }

            body += `\n**Workflow Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üîç Manual Secret Scan - ${report.matchesFound} secrets found`,
              body: body,
              labels: ['security', 'manual-scan']
            });

      - name: Fail if configured and secrets found
        if: inputs.fail_on_detection && steps.scan.outcome == 'failure'
        run: |
          echo "‚ùå Secrets detected - failing workflow as configured"
          exit 1

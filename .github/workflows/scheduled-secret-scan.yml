name: Scheduled Secret Scan

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  scheduled-scan:
    name: Daily Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run comprehensive secret scan
        id: scan
        run: |
          echo "ðŸ” Running scheduled security audit..."
          tsx scripts/ci-secret-scan.ts
        continue-on-error: true

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scheduled-scan-results-${{ github.run_number }}
          path: secret-scan-report.json
          retention-days: 90

      - name: Create issue if secrets found
        if: steps.scan.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('secret-scan-report.json', 'utf8'));

            const criticalCount = report.matches.filter(m => m.severity === 'critical').length;
            const highCount = report.matches.filter(m => m.severity === 'high').length;
            const mediumCount = report.matches.filter(m => m.severity === 'medium').length;
            const lowCount = report.matches.filter(m => m.severity === 'low').length;

            let body = '## ðŸš¨ Scheduled Secret Scan Alert\n\n';
            body += `**Date:** ${new Date().toISOString()}\n`;
            body += `**Scan Run:** #${context.runNumber}\n\n`;
            body += '### Secrets Detected:\n\n';
            body += '| Severity | Count |\n';
            body += '|----------|-------|\n';
            if (criticalCount > 0) body += `| ðŸ”´ CRITICAL | ${criticalCount} |\n`;
            if (highCount > 0) body += `| ðŸŸ  HIGH | ${highCount} |\n`;
            if (mediumCount > 0) body += `| ðŸŸ¡ MEDIUM | ${mediumCount} |\n`;
            if (lowCount > 0) body += `| âšª LOW | ${lowCount} |\n`;

            body += `\n**Total Issues:** ${report.matchesFound}\n`;
            body += `**Files Affected:** ${[...new Set(report.matches.map(m => m.file))].length}\n\n`;

            body += '### Affected Files:\n\n';
            const byFile = {};
            for (const match of report.matches) {
              if (!byFile[match.file]) byFile[match.file] = [];
              byFile[match.file].push(match);
            }

            for (const [file, matches] of Object.entries(byFile)) {
              body += `\n**ðŸ“„ ${file}** (${matches.length} issue(s))\n`;
              for (const match of matches.slice(0, 5)) {  // Show first 5 per file
                const icon = match.severity === 'critical' ? 'ðŸ”´' :
                            match.severity === 'high' ? 'ðŸŸ ' :
                            match.severity === 'medium' ? 'ðŸŸ¡' : 'âšª';
                body += `- ${icon} Line ${match.line}: ${match.patternName}\n`;
              }
              if (matches.length > 5) {
                body += `- ... and ${matches.length - 5} more\n`;
              }
            }

            body += '\n---\n\n';
            body += '### ðŸ”¥ IMMEDIATE ACTIONS REQUIRED:\n\n';
            body += '1. **Rotate all exposed credentials immediately**\n';
            body += '2. Remove secrets from codebase\n';
            body += '3. Use environment variables instead\n';
            body += '4. Review commit history for exposure timeline\n';
            body += '5. Check access logs for potential unauthorized use\n\n';

            body += '### ðŸ“Š Scan Details:\n\n';
            body += `- **Workflow Run:** [View Results](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n`;
            body += `- **Artifact:** scheduled-scan-results-${context.runNumber}\n`;
            body += `- **Files Scanned:** ${report.scannedFiles}\n\n`;

            body += '---\n';
            body += '*This issue was automatically created by the scheduled secret scanning workflow.*';

            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['security', 'secrets-detected']
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Scheduled Secret Scan Alert')
            );

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ðŸ”„ Updated Scan Results\n\n${body}`
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Scheduled Secret Scan Alert - Secrets Detected',
                body: body,
                labels: ['security', 'secrets-detected', 'critical']
              });
              console.log('Created new security issue');
            }

      - name: Send notification on failure
        if: steps.scan.outcome == 'failure'
        run: |
          echo "ðŸš¨ SECURITY ALERT: Secrets detected in scheduled scan"
          echo "An issue has been created with details"
          echo "Review the scan results artifact for full details"

      - name: Report success
        if: steps.scan.outcome == 'success'
        run: |
          echo "âœ… Scheduled security scan passed"
          echo "No secrets detected in codebase"

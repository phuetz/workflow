name: Secret Scanning

on:
  pull_request:
    branches: [ main, master, develop ]
  push:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  secret-scan:
    name: Scan for Exposed Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better scanning

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run secret scanner
        id: scan
        run: |
          echo "ğŸ” Running secret scanner on codebase..."
          tsx scripts/ci-secret-scan.ts
        continue-on-error: true

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-results
          path: secret-scan-report.json
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && steps.scan.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('secret-scan-report.json', 'utf8'));

            const criticalCount = report.matches.filter(m => m.severity === 'critical').length;
            const highCount = report.matches.filter(m => m.severity === 'high').length;
            const mediumCount = report.matches.filter(m => m.severity === 'medium').length;
            const lowCount = report.matches.filter(m => m.severity === 'low').length;

            let comment = '## ğŸš¨ Secret Scanning Results\n\n';
            comment += '**Secrets detected in this PR!**\n\n';
            comment += '| Severity | Count |\n';
            comment += '|----------|-------|\n';
            if (criticalCount > 0) comment += `| ğŸ”´ CRITICAL | ${criticalCount} |\n`;
            if (highCount > 0) comment += `| ğŸŸ  HIGH | ${highCount} |\n`;
            if (mediumCount > 0) comment += `| ğŸŸ¡ MEDIUM | ${mediumCount} |\n`;
            if (lowCount > 0) comment += `| âšª LOW | ${lowCount} |\n`;

            comment += '\n### Issues Found:\n\n';

            const byFile = {};
            for (const match of report.matches) {
              if (!byFile[match.file]) byFile[match.file] = [];
              byFile[match.file].push(match);
            }

            for (const [file, matches] of Object.entries(byFile)) {
              comment += `\n**ğŸ“„ ${file}**\n`;
              for (const match of matches) {
                const icon = match.severity === 'critical' ? 'ğŸ”´' :
                            match.severity === 'high' ? 'ğŸŸ ' :
                            match.severity === 'medium' ? 'ğŸŸ¡' : 'âšª';
                comment += `- ${icon} Line ${match.line}: ${match.patternName}\n`;
              }
            }

            comment += '\n---\n';
            comment += 'âš ï¸ **This PR cannot be merged until all secrets are removed.**\n\n';
            comment += '### How to fix:\n';
            comment += '1. Remove secrets from the code\n';
            comment += '2. Use environment variables (`.env` files)\n';
            comment += '3. Never commit `.env` files (add to `.gitignore`)\n';
            comment += '4. **Rotate any exposed credentials immediately**\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if secrets found
        if: steps.scan.outcome == 'failure'
        run: |
          echo "âŒ Secret scanning failed - secrets detected in codebase"
          echo "Review the scan results artifact for details"
          exit 1

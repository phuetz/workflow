apiVersion: batch/v1
kind: CronJob
metadata:
  name: workflow-backup
  namespace: workflow-platform
spec:
  # Run daily at 2 AM
  schedule: "0 2 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 3600  # 1 hour timeout
      template:
        metadata:
          labels:
            app: workflow-backup
        spec:
          restartPolicy: OnFailure
          serviceAccountName: workflow-backup-sa
          containers:
          - name: backup
            image: ghcr.io/your-org/workflow-backup:latest
            imagePullPolicy: IfNotPresent
            env:
            - name: BACKUP_DIR
              value: "/backups"
            - name: S3_BUCKET
              value: "s3://workflow-prod-backups"
            - name: RETENTION_DAYS
              value: "30"
            - name: DATABASE_HOST
              valueFrom:
                secretKeyRef:
                  name: workflow-db-secret
                  key: host
            - name: DATABASE_PORT
              valueFrom:
                secretKeyRef:
                  name: workflow-db-secret
                  key: port
            - name: DATABASE_NAME
              valueFrom:
                secretKeyRef:
                  name: workflow-db-secret
                  key: database
            - name: DATABASE_USER
              valueFrom:
                secretKeyRef:
                  name: workflow-db-secret
                  key: username
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: workflow-db-secret
                  key: password
            - name: REDIS_HOST
              value: "workflow-redis"
            - name: REDIS_PORT
              value: "6379"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: access-key-id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: secret-access-key
            - name: AWS_DEFAULT_REGION
              value: "us-east-1"
            - name: SLACK_WEBHOOK
              valueFrom:
                secretKeyRef:
                  name: notification-secrets
                  key: slack-webhook
                  optional: true
            volumeMounts:
            - name: backup-volume
              mountPath: /backups
            - name: backup-script
              mountPath: /scripts
            command: ["/bin/bash"]
            args: ["/scripts/backup-production.sh"]
            resources:
              requests:
                memory: "256Mi"
                cpu: "100m"
              limits:
                memory: "512Mi"
                cpu: "500m"
          volumes:
          - name: backup-volume
            persistentVolumeClaim:
              claimName: workflow-backup-pvc
          - name: backup-script
            configMap:
              name: backup-scripts
              defaultMode: 0755
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: workflow-backup-pvc
  namespace: workflow-platform
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
  storageClassName: fast-ssd
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: workflow-backup-sa
  namespace: workflow-platform
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: workflow-backup-role
  namespace: workflow-platform
rules:
- apiGroups: [""]
  resources: ["pods", "pods/log"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: workflow-backup-rolebinding
  namespace: workflow-platform
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: workflow-backup-role
subjects:
- kind: ServiceAccount
  name: workflow-backup-sa
  namespace: workflow-platform
